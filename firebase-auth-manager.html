<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../akc-meta/akc-meta.html">
<link rel="import" href="../paper-toast/paper-toast.html">

<link rel="import" href="../polymerfire/firebase-auth.html">
<link rel="import" href="../polymerfire/firebase-document.html">

<link rel="import" href="./firebase-error-dialog.html">

<!--
`<firebase-auth-manager>` is a wrapper element to `<firebase-auth>` that listens to the various `sign-XXX` event and delegate their execution.
Whenever an error occurs during a firebase operation, it displays an error dialog with the corresponding error message. For successful operation, it shows a toast.
It also provides the update of the global variables used by `<firebase-state>`.

@group GoogleWebComponents Elements
@element firebase-auth-manager
@hero hero.svg
@demo demo/index.html
-->
<dom-module id="firebase-auth-manager">
  <template>
      <akc-meta key="logged" value="[[_logged]]"></akc-meta>
      <!-- TODO PG: check if we can switch this to 2 way-data binding if we solved the query issue... -->
      <akc-meta key="user" value="[[_user]]"></akc-meta>
      <!-- TODO PG: check if we can switch this to 2 way-data binding if we solved the query issue... -->
      <akc-meta key="profile" value="[[_profile]]"></akc-meta>
      <akc-meta key="profilePath" value="[[_profilePath]]"></akc-meta>
      <akc-meta key="appName" value="[[appName]]"></akc-meta>

      <firebase-auth app-name="[[appName]]"
                     id="firebaseAuth"
                     user="{{_user}}"
                     signed-in="{{_logged}}">
      </firebase-auth>

      <!-- TODO PG: remove log when test are finished... -->
      <firebase-document log
                         app-name="[[appName]]"
                         path="{{_profilePath}}"
                         data="{{_profile}}"
                         on-firebase-value="_firebaseProfileLoaded">
      </firebase-document>

      <firebase-error-dialog id="errorDialog"
                             hidden$="{{!_lastError}}"
                             entry-animation="scale-up-animation"
                             exit-animation="fade-out-animation"
                             modal>
        <span error>[[_lastError]]</span>
      </firebase-error-dialog>

      <!-- TODO PG: eventually write a firebase-toast and extract it-->
      <paper-toast id="toast" text="[[_toastMessage]]" duration="3000"></paper-toast>
  </template>
  <script>

    Polymer({

      is: 'firebase-auth-manager',

      properties: {

        /**
         * User used for the `<firebase-auth>` inner element
         */
        _user: {
          type: Object,
          value: null
        },

        /**
         * Logged used for the `<firebase-auth>` inner element
         */
        _logged: {
          type: Boolean,
          value: false
        },

        /**
         * AppName used for `<firebase-auth>` inner element
         */
        appName: {
          type: String,
          value: null
        },

        /**
         * Computed path used for the profile firebase document
         */
        _profilePath: {
          type: String,
          computed: '_computeProfilePath(_user)',
          value: '/profiles/undefined'
        },

        /**
         * Value of the profile firebase document
         */
        _profile: {
          type: Object,
          value: null
        },

        /**
         * Last error that occured with one of the auth service
         */
        _lastError: {
          type: String,
          value: ''
        },

        /**
         * Text message of the toast
         */
        _toastMessage: {
          type: String
        }
      },

      attached: function() {
        window.addEventListener('sign-up', this._signUpHandler.bind(this));
        window.addEventListener('sign-in', this._signInHandler.bind(this));
        window.addEventListener('sign-out', this._signOutHandler.bind(this));
        window.addEventListener('user-created', this._userHandler.bind(this));
        window.addEventListener('login', this._userHandler.bind(this));
        window.addEventListener('logout', this._userHandler.bind(this));
        window.addEventListener('error', this._errorHandler.bind(this));
      },

      detached: function() {
        window.removeEventListener('sign-up', this._signUpHandler.bind(this));
        window.removeEventListener('sign-in', this._signInHandler.bind(this));
        window.removeEventListener('sign-out', this._signOutHandler.bind(this));
        window.removeEventListener('user-created', this._userHandler.bind(this));
        window.removeEventListener('login', this._userHandler.bind(this));
        window.removeEventListener('logout', this._userHandler.bind(this));
        window.removeEventListener('error', this._errorHandler.bind(this));
      },

      _computeProfilePath: function(user) {
        console.log("compute profile path");
        if (user && user.uid) {
          console.log(['/profiles', user.uid].join('/'));
          return ['/profiles', user.uid].join('/');
        } else {
          return '/profiles/undefined';
        }
      },

      _firebaseProfileLoaded: function() {
        console.log("Profile loaded");
        if (this._user && !this._profile) {
          var profile = {};
          var user = this._user;
          var providerInfo = user.providerData;
          var i;

          profile.displayName = user.displayName;
          if (!profile.displayName) {
            for (i=0; i<providerInfo.length; i++) {
              profile.displayName = providerInfo[i].displayName;
              if (profile.displayName) break;
            }
            profile.displayName = profile.displayName || '';
          }
          profile.email = user.email;
          if (!profile.email) {
            for (i=0; i<providerInfo.length; i++) {
              profile.email = providerInfo[i].email;
              if (profile.email) break;
            }
            profile.email = profile.email || '';
          }
          profile.picture = user.photoURL;
          if (!profile.picture) {
            for (i=0; i<providerInfo.length; i++) {
              profile.picture = providerInfo[i].photoURL;
              if (profile.picture) break;
            }
            profile.picture = profile.picture || '';
          }
          this.set('_profile', profile);
        }
      },

      _signUpHandler: function(e) {
        this.$.firebaseAuth.createUserWithEmailAndPassword(
          e.detail.params.email,
          e.detail.params.password
        );
      },

      _signInHandler: function(e) {
        this.$.firebaseAuth.provider = e.detail.provider;
        console.log("Provider: " + this.$.firebaseAuth.provider);
        if (e.detail.provider == "password") {
          this.$.firebaseAuth.signInWithEmailAndPassword(
            e.detail.params.email,
            e.detail.params.password
          );
        }
        else {
          this.$.firebaseAuth.signInWithPopup();
        }
      },

      _signOutHandler: function() {
        this.$.firebaseAuth.signOut();
        this.async(function() {
          this.set('_profile', undefined);
        });
      },

      _userHandler: function(e) {
        switch (e.type) {
          case 'user-created':
            this._toastMessage = 'Sign-Up ';
            break;
          case 'login':
            this._toastMessage = 'Sign-In ';
            break;
          case 'logout':
            this._toastMessage = 'Sign-Out ';
            break;
        }
        this._toastMessage += 'successful!';
        this.$.toast.open();
      },

      _errorHandler: function(e) {
        if (e.detail && e.detail.code == 'auth/popup-blocked') {
          this.$.firebaseAuth.signInWithRedirect();
          return;
        }
        this._lastError = e.detail;
        if (this._lastError) {
          this.$.errorDialog.open();
        } else {
          console.error('Unknown error: ' + JSON.stringify(e));
        }
      }

    });

  </script>
</dom-module>
