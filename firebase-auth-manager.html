<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../akc-meta/akc-meta.html">
<link rel="import" href="../paper-toast/paper-toast.html">

<link rel="import" href="../firebase-element/firebase-auth.html">
<link rel="import" href="./firebase-error-dialog.html">

<!--
`<firebase-auth-manager>` is a wrapper element to `<firebase-auth>` that listens to the various `sign-XXX` event and delegate their execution.
It also provides the update of the global variables used by `<firebase-state>`.

@group GoogleWebComponents Elements
@element firebase-auth-manager
@hero hero.svg
@demo demo/index.html
-->
<dom-module id="firebase-auth-manager">
  <template>
      <akc-meta key="logged" value="[[_computeLoggedState(statusKnown,user)]]"></akc-meta>
      <akc-meta key="user" value="[[user]]"></akc-meta>
      <firebase-auth id="firebaseAuth"
        user="{{user}}"
        status-known="{{statusKnown}}"
        location="[[location]]"
        >
      </firebase-auth>
      <firebase-error-dialog id="errorDialog"
        entry-animation="scale-up-animation"
        exit-animation="fade-out-animation"
        modal>
          <span error>[[lastError]]</span>
      </firebase-error-dialog>
      <!-- TODO PG: eventually write a firebase-toast -->
      <paper-toast id="toast" text="[[toastMessage]]" duration="3000"></paper-toast>
  </template>
  <script>

    Polymer({

      is: 'firebase-auth-manager',

      properties: {

        /**
         * Location used for the `<firebase-auth>` inner element
         */
        location: {
          type: String
        },

        /**
         * Last error that occured with one of the auth service
         */
        lastError: {
          type: String
        },

        /**
         * Last error that occured with one of the auth service
         */
        toastMessage: {
          type: String
        },
      },

      attached: function() {
        window.addEventListener('sign-up', this._signUpHandler.bind(this));
        window.addEventListener('sign-in', this._signInHandler.bind(this));
        window.addEventListener('sign-out', this._signOutHandler.bind(this));
        window.addEventListener('user-created', this._userHandler.bind(this));
        window.addEventListener('login', this._userHandler.bind(this));
        window.addEventListener('logout', this._userHandler.bind(this));
        window.addEventListener('error', this._errorHandler.bind(this));
      },

      detached: function() {
      },

      _signUpHandler: function(e) {
        this.$.firebaseAuth.createUser(e.detail.params.email, e.detail.params.password);
      },

      _signInHandler: function(e) {
        this.$.firebaseAuth.provider = e.detail.provider;
        this.$.firebaseAuth.login(e.detail.params);
      },

      _signOutHandler: function(e) {
        this.$.firebaseAuth.logout();
      },

      _userHandler: function(e) {
        switch(e.type) {
          case "user-created":
            this.toastMessage = "Registration ";
            break;
          case "login":
            this.toastMessage = "Login ";
            break;
          case "logout":
            this.toastMessage = "Logout ";
            break;
        }
        this.toastMessage += "successful!";
        this.$.toast.open();
      },

      _errorHandler: function(e) {
        this.lastError = e.detail;
        this.$.errorDialog.open();
      },

      _computeLoggedState: function(statusKnown,user) {
        return statusKnown && !!user;
      }

    });

  </script>
</dom-module>
